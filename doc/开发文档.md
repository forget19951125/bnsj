# 币安事件合约群控交易系统 - 开发文档

## 1. 项目结构

```
bn_auto/
├── server/                 # 后台服务端
│   ├── app/               # 应用主目录
│   │   ├── __init__.py
│   │   ├── main.py        # 服务启动入口
│   │   ├── config.py      # 配置文件
│   │   ├── database.py    # 数据库连接
│   │   └── redis_client.py # Redis连接
│   ├── models/            # 数据模型
│   │   ├── __init__.py
│   │   ├── order.py       # 订单模型
│   │   └── user.py        # 用户模型
│   ├── api/               # API接口
│   │   ├── __init__.py
│   │   ├── order.py       # 订单相关API
│   │   ├── user.py        # 用户相关API
│   │   └── auth.py        # 认证相关API
│   ├── services/          # 业务逻辑层
│   │   ├── __init__.py
│   │   ├── order_service.py
│   │   └── user_service.py
│   ├── utils/             # 工具函数
│   │   ├── __init__.py
│   │   └── decorators.py
│   ├── requirements.txt   # Python依赖
│   └── migrations/        # 数据库迁移脚本
│       └── init.sql
├── client/                # 客户端
│   ├── app/               # 应用主目录
│   │   ├── __init__.py
│   │   ├── main.py        # 客户端启动入口
│   │   ├── config.py      # 配置文件
│   │   ├── api_client.py  # 服务器API客户端
│   │   └── binance_client.py # 币安客户端（复用原项目代码）
│   ├── ui/                # 用户界面
│   │   ├── __init__.py
│   │   ├── login_window.py    # 登录窗口
│   │   ├── main_window.py    # 主窗口
│   │   └── qr_window.py      # 二维码窗口
│   ├── services/          # 业务逻辑
│   │   ├── __init__.py
│   │   ├── auth_service.py   # 认证服务
│   │   ├── order_service.py  # 订单服务
│   │   └── binance_service.py # 币安服务
│   ├── utils/             # 工具函数
│   │   ├── __init__.py
│   │   └── token_manager.py  # Token管理
│   └── requirements.txt   # Python依赖
└── doc/                   # 文档目录
    ├── 产品文档.md
    └── 开发文档.md
```

## 2. 数据库设计

### 2.1 MySQL 数据库配置

参考 `nof1` 项目的配置格式：
```yaml
database:
  mysql:
    host: "localhost"
    port: 3306
    user: "root"
    password: "your_mysql_password"
    database: "bn_auto"
  redis:
    host: "localhost"
    port: 6379
    password: ""
    db: 0
```

### 2.2 数据表设计

#### 2.2.1 用户表 (users)
```sql
CREATE TABLE users (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    username VARCHAR(50) UNIQUE NOT NULL COMMENT '用户名',
    password VARCHAR(255) NOT NULL COMMENT '密码（加密）',
    status TINYINT DEFAULT 1 COMMENT '状态：1-正常，2-已过期，3-已禁用',
    expire_at DATETIME COMMENT '账号过期时间',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_username (username),
    INDEX idx_status (status),
    INDEX idx_expire_at (expire_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户表';
```

#### 2.2.2 订单表 (orders)
```sql
CREATE TABLE orders (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    time_increments VARCHAR(50) NOT NULL COMMENT '时间增量，如TEN_MINUTE',
    symbol_name VARCHAR(20) NOT NULL COMMENT '交易对，如BTCUSDT',
    direction VARCHAR(10) NOT NULL COMMENT '方向：LONG或SHORT',
    valid_duration INT NOT NULL COMMENT '有效时间（秒）',
    status TINYINT DEFAULT 1 COMMENT '状态：1-待分配，2-已分配，3-已过期',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_status (status),
    INDEX idx_created_at (created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='订单表';
```

#### 2.2.3 订单分配记录表 (order_assignments)
```sql
CREATE TABLE order_assignments (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    order_id BIGINT NOT NULL COMMENT '订单ID',
    user_id BIGINT NOT NULL COMMENT '用户ID',
    assigned_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '分配时间',
    executed_at DATETIME COMMENT '执行时间',
    execution_result TEXT COMMENT '执行结果（JSON）',
    FOREIGN KEY (order_id) REFERENCES orders(id) ON DELETE CASCADE,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    UNIQUE KEY uk_order_user (order_id, user_id),
    INDEX idx_user_id (user_id),
    INDEX idx_assigned_at (assigned_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='订单分配记录表';
```

## 3. Redis 数据结构设计

### 3.1 订单去重
- **Key**: `order:assigned:{order_id}:{user_id}`
- **Value**: `1`
- **TTL**: 订单有效时间 + 1小时（防止过期订单重复分配）

### 3.2 用户会话
- **Key**: `session:{user_id}`
- **Value**: JSON字符串，包含登录时间、token等信息
- **TTL**: 24小时

### 3.3 订单缓存
- **Key**: `order:cache:{order_id}`
- **Value**: 订单JSON数据
- **TTL**: 订单有效时间

## 4. API 接口设计

### 4.1 认证接口

#### 4.1.1 用户登录
```
POST /api/auth/login
Request:
{
    "username": "string",
    "password": "string"
}
Response:
{
    "code": 200,
    "message": "success",
    "data": {
        "token": "jwt_token",
        "user_id": 1,
        "expire_at": "2024-01-01 12:00:00"
    }
}
```

#### 4.1.2 验证Token
```
GET /api/auth/verify
Headers:
    Authorization: Bearer {token}
Response:
{
    "code": 200,
    "message": "success",
    "data": {
        "user_id": 1,
        "username": "string"
    }
}
```

### 4.2 订单接口

#### 4.2.1 创建订单（管理员）
```
POST /api/orders/create
Headers:
    Authorization: Bearer {admin_token}
Request:
{
    "time_increments": "TEN_MINUTE",
    "symbol_name": "BTCUSDT",
    "direction": "LONG",
    "valid_duration": 3600
}
Response:
{
    "code": 200,
    "message": "success",
    "data": {
        "order_id": 1
    }
}
```

#### 4.2.2 拉取订单（客户端）
```
GET /api/orders/pull
Headers:
    Authorization: Bearer {token}
Response:
{
    "code": 200,
    "message": "success",
    "data": {
        "order": {
            "id": 1,
            "time_increments": "TEN_MINUTE",
            "symbol_name": "BTCUSDT",
            "direction": "LONG",
            "valid_duration": 3600,
            "created_at": "2024-01-01 10:00:00"
        }
    }
}
注意：如果没有可用订单，返回 null
```

#### 4.2.3 标记订单已拉取
```
POST /api/orders/mark-assigned
Headers:
    Authorization: Bearer {token}
Request:
{
    "order_id": 1
}
Response:
{
    "code": 200,
    "message": "success"
}
```

#### 4.2.4 记录下单结果
```
POST /api/orders/record-result
Headers:
    Authorization: Bearer {token}
Request:
{
    "order_id": 1,
    "result": {
        "success": true,
        "message": "下单成功",
        "data": {...}
    }
}
Response:
{
    "code": 200,
    "message": "success"
}
```

### 4.3 用户管理接口（管理员）

#### 4.3.1 创建用户
```
POST /api/admin/users/create
Headers:
    Authorization: Bearer {admin_token}
Request:
{
    "username": "string",
    "password": "string",
    "expire_at": "2024-12-31 23:59:59"
}
Response:
{
    "code": 200,
    "message": "success",
    "data": {
        "user_id": 1
    }
}
```

#### 4.3.2 更新用户有效期
```
PUT /api/admin/users/{user_id}/expire
Headers:
    Authorization: Bearer {admin_token}
Request:
{
    "expire_at": "2024-12-31 23:59:59"
}
Response:
{
    "code": 200,
    "message": "success"
}
```

#### 4.3.3 用户列表
```
GET /api/admin/users
Headers:
    Authorization: Bearer {admin_token}
Query Parameters:
    page: 1
    page_size: 20
Response:
{
    "code": 200,
    "message": "success",
    "data": {
        "total": 100,
        "list": [...]
    }
}
```

## 5. 服务端实现要点

### 5.1 订单拉取逻辑

```python
def pull_order(user_id):
    # 1. 查询待分配的订单
    orders = get_pending_orders()
    
    # 2. 过滤已过期的订单
    current_time = datetime.now()
    valid_orders = []
    for order in orders:
        elapsed = (current_time - order.created_at).total_seconds()
        if elapsed < order.valid_duration:
            valid_orders.append(order)
    
    # 3. 检查用户是否已拉取（Redis去重）
    for order in valid_orders:
        key = f"order:assigned:{order.id}:{user_id}"
        if not redis_client.exists(key):
            # 4. 标记为已拉取
            redis_client.setex(key, order.valid_duration + 3600, "1")
            # 5. 记录到数据库
            record_order_assignment(order.id, user_id)
            return order
    
    return None
```

### 5.2 账号过期检查

```python
def check_user_expire(user_id):
    user = get_user(user_id)
    if user.status == 2:  # 已过期
        return False
    if user.expire_at and user.expire_at < datetime.now():
        # 更新状态为已过期
        update_user_status(user_id, 2)
        return False
    return True
```

### 5.3 Token 管理

- 使用 JWT 生成登录 Token
- Token 有效期 24 小时
- Token 存储在 Redis 中，用于快速验证

## 6. 客户端实现要点

### 6.1 登录流程

```python
def login(username, password):
    # 1. 调用登录API
    response = api_client.login(username, password)
    
    # 2. 保存Token和用户信息
    token_manager.save_token(response.token)
    token_manager.save_user_info(response.user_id, response.expire_at)
    
    # 3. 检查账号是否过期
    if not check_account_valid():
        raise Exception("账号已过期，请联系管理员")
    
    # 4. 启动24小时倒计时
    start_session_timer()
```

### 6.2 币安登录流程

```python
def bind_binance():
    # 1. 调用get_token函数（复用原项目代码）
    token_info = get_token(reset=False, headless=False)
    
    # 2. 保存Token信息
    token_manager.save_binance_token(
        token_info['csrftoken'],
        token_info['p20t'],
        token_info['expirationTimestamp']
    )
```

### 6.3 订单拉取和下单流程

```python
def order_loop():
    while True:
        try:
            # 1. 拉取订单
            order = api_client.pull_order()
            
            if order:
                # 2. 检查订单有效期
                if is_order_valid(order):
                    # 3. 获取用户设置的下单金额
                    amount = get_order_amount()
                    
                    # 4. 调用下单接口
                    result = place_order_web(
                        csrftoken=token_manager.get_csrftoken(),
                        p20t=token_manager.get_p20t(),
                        orderAmount=str(amount),
                        timeIncrements=order['time_increments'],
                        symbolName=order['symbol_name'],
                        payoutRatio="0.80",
                        direction=order['direction']
                    )
                    
                    # 5. 记录结果
                    api_client.record_order_result(order['id'], result)
            
            # 6. 等待1秒
            time.sleep(1)
            
        except Exception as e:
            log_error(e)
            time.sleep(1)
```

### 6.4 24小时会话管理

```python
def start_session_timer():
    login_time = datetime.now()
    session_duration = timedelta(hours=24)
    
    def check_session():
        if datetime.now() - login_time > session_duration:
            # 会话过期，退出到登录界面
            logout()
    
    # 每秒检查一次
    threading.Timer(1.0, check_session).start()
```

## 7. 技术选型

### 7.1 服务端框架
- **Web框架**: FastAPI（高性能、自动生成API文档）
- **ORM**: SQLAlchemy
- **Redis客户端**: redis-py
- **JWT**: PyJWT

### 7.2 客户端框架
- **GUI框架**: tkinter（Python内置，跨平台）
- **HTTP客户端**: requests
- **币安客户端**: 复用原项目的 `main.py` 中的函数

### 7.3 数据库
- **MySQL**: 存储用户、订单等持久化数据
- **Redis**: 缓存、去重、会话管理

## 8. 配置文件

### 8.1 服务端配置 (server/app/config.py)

```python
import os
from pydantic import BaseSettings

class Settings(BaseSettings):
    # 数据库配置
    mysql_host: str = "localhost"
    mysql_port: int = 3306
    mysql_user: str = "root"
    mysql_password: str = ""
    mysql_database: str = "bn_auto"
    
    # Redis配置
    redis_host: str = "localhost"
    redis_port: int = 6379
    redis_password: str = ""
    redis_db: int = 0
    
    # JWT配置
    jwt_secret: str = "your-secret-key"
    jwt_expire_hours: int = 24
    
    # 管理员Token（用于后台管理）
    admin_token: str = "admin-secret-token"
    
    class Config:
        env_file = ".env"
```

### 8.2 客户端配置 (client/app/config.py)

```python
import os
from pydantic import BaseSettings

class Settings(BaseSettings):
    # 服务器地址
    server_url: str = "http://localhost:8000"
    
    # 默认下单金额
    default_order_amount: float = 5.0
    min_order_amount: float = 5.0
    max_order_amount: float = 200.0
    
    # 订单拉取间隔（秒）
    order_pull_interval: int = 1
    
    # 会话有效期（小时）
    session_expire_hours: int = 24
    
    class Config:
        env_file = ".env"
```

## 9. 部署说明

### 9.1 服务端部署

1. 安装依赖：
```bash
cd server
pip install -r requirements.txt
```

2. 初始化数据库：
```bash
mysql -u root -p < migrations/init.sql
```

3. 配置环境变量（创建 `.env` 文件）

4. 启动服务：
```bash
python app/main.py
```

### 9.2 客户端部署

1. 安装依赖：
```bash
cd client
pip install -r requirements.txt
```

2. 配置服务器地址（修改 `config.py` 或 `.env`）

3. 启动客户端：
```bash
python app/main.py
```

## 10. 测试计划

### 10.1 单元测试
- 订单去重逻辑测试
- 订单有效期检查测试
- 账号过期检查测试

### 10.2 集成测试
- 订单创建和拉取流程测试
- 用户登录和会话管理测试
- 下单流程测试

### 10.3 压力测试
- 并发订单拉取测试
- 多客户端同时在线测试

## 11. 开发注意事项

1. **订单去重**：必须使用 Redis 实现，确保高并发下的准确性
2. **订单有效期**：每次拉取时都要检查，防止过期订单被执行
3. **账号过期**：登录时和每次API调用时都要检查
4. **会话管理**：客户端24小时自动退出，服务端也要验证Token有效期
5. **错误处理**：所有API调用都要有完善的错误处理和重试机制
6. **日志记录**：关键操作都要记录日志，便于排查问题
7. **安全性**：密码加密存储，Token安全传输

