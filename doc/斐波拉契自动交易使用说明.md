# 斐波拉契自动交易系统使用说明

## 一、系统概述

本系统集成了`2.py`中的斐波拉契扩展位计算逻辑，实现了基于斐波拉契扩展位和RSI指标的自动订单生成功能。

## 二、功能说明

### 2.1 斐波拉契点位同步

当`2.py`中的`send_instant_alert`函数触发时，需要调用服务器API同步30分钟的双向斐波拉契扩展位。

**API接口**：`POST /api/fib/sync-levels`

**请求示例**：
```python
import requests

url = "http://your-server:8000/api/fib/sync-levels"
data = {
    "up_data": {
        "fib_1618": 3500.50,
        "a_price": 3000.00,
        "b_price": 3300.00,
        "c_price": 3250.00,
        "trend": "up"
    },
    "down_data": {
        "fib_1618": 3200.30,
        "a_price": 3400.00,
        "b_price": 3100.00,
        "c_price": 3150.00,
        "trend": "down"
    }
}

response = requests.post(url, json=data)
```

**在2.py中集成**：

修改`send_instant_alert`函数，在发送告警后同步点位：

```python
def send_instant_alert(self, volume_data, fib_data, rsi_value):
    """发送精简告警到钉钉 - 包含量能、双向斐波那契扩展位和RSI"""
    # ... 原有代码 ...
    
    # 同步30分钟的斐波拉契点位到服务器
    if '30min' in fib_data and fib_data['30min']:
        try:
            import requests
            sync_url = "http://your-server:8000/api/fib/sync-levels"
            sync_data = {
                "up_data": fib_data['30min'].get('up'),
                "down_data": fib_data['30min'].get('down')
            }
            requests.post(sync_url, json=sync_data, timeout=5)
            print("✓ 斐波拉契点位已同步到服务器")
        except Exception as e:
            print(f"⚠️ 同步点位失败: {e}")
```

### 2.2 自动订单生成

服务器会自动监控ETHUSDT合约价格，当满足以下条件时自动生成订单：

**空单生成条件**：
- 合约价格 >= 上升1.618扩展点位
- 当前分钟K的RSI >= 75
- 生成订单：10分钟ETHUSDT空单 + 30分钟ETHUSDT空单

**多单生成条件**：
- 合约价格 <= 下降1.618扩展点位
- 当前分钟K的RSI <= 25
- 生成订单：10分钟ETHUSDT多单 + 30分钟ETHUSDT多单

**订单生成后**：
- 自动清空缓存的扩展点位
- 等待下一次`send_instant_alert`触发重新缓存

### 2.3 后台显示

在后台管理页面的订单管理标签页中，可以看到：

1. **斐波拉契交易点位区域**：
   - 上升1.618点位（绿色显示）
   - 下降1.618点位（红色显示）
   - A/B/C点详细信息
   - 当前ETHUSDT价格
   - 当前RSI值
   - 缓存时间

2. **自动刷新**：每5秒自动刷新一次点位信息

## 三、配置说明

### 3.1 服务器配置

确保服务器已安装以下依赖：
```bash
pip install ccxt pandas numpy
```

### 3.2 价格监控

价格监控服务会在服务器启动时自动启动，每秒检查一次价格和RSI条件。

**监控日志**：
- 监控启动：`✓ 价格监控已启动（每秒检查一次）`
- 触发条件：`触发空单条件: 价格=3500.50, 上升点位=3500.50, RSI=75.00`
- 订单创建：`✓ 创建10分钟订单: ID=123, 方向=SHORT, 价格=3500.50, RSI=75.00`

## 四、API接口

### 4.1 同步斐波拉契点位

**接口**：`POST /api/fib/sync-levels`

**请求体**：
```json
{
  "up_data": {
    "fib_1618": 3500.50,
    "a_price": 3000.00,
    "b_price": 3300.00,
    "c_price": 3250.00,
    "trend": "up"
  },
  "down_data": {
    "fib_1618": 3200.30,
    "a_price": 3400.00,
    "b_price": 3100.00,
    "c_price": 3150.00,
    "trend": "down"
  }
}
```

**响应**：
```json
{
  "code": 200,
  "message": "点位已缓存"
}
```

### 4.2 查询当前点位

**接口**：`GET /api/fib/current-levels`

**响应**：
```json
{
  "code": 200,
  "data": {
    "up_data": {
      "fib_1618": 3500.50,
      "a_price": 3000.00,
      "b_price": 3300.00,
      "c_price": 3250.00
    },
    "down_data": {
      "fib_1618": 3200.30,
      "a_price": 3400.00,
      "b_price": 3100.00,
      "c_price": 3150.00
    },
    "cached_at": "2024-01-01T12:00:00",
    "current_price": 3400.00,
    "current_rsi": 50.0
  }
}
```

## 五、注意事项

1. **价格精度**：系统使用0.01的价格容差，避免因价格波动导致的频繁触发
2. **并发安全**：订单生成使用锁机制，防止重复生成
3. **缓存过期**：斐波拉契点位缓存24小时过期
4. **订单生成后**：点位会被清空，需要等待下一次`send_instant_alert`触发
5. **币种限制**：系统只支持ETHUSDT，不再支持BTCUSDT

## 六、故障排查

### 6.1 点位未显示

- 检查是否已调用`/api/fib/sync-levels`接口
- 检查Redis连接是否正常
- 查看服务器日志

### 6.2 订单未生成

- 检查价格是否达到扩展点位
- 检查RSI是否满足条件（空单>=75，多单<=25）
- 检查是否有缓存的点位（点位可能已被清空）
- 查看服务器日志中的监控信息

### 6.3 价格监控未启动

- 检查服务器启动日志
- 确保ccxt、pandas、numpy已正确安装
- 检查币安API连接是否正常

## 七、测试建议

1. **点位同步测试**：
   - 手动调用`/api/fib/sync-levels`接口
   - 检查后台是否显示点位

2. **订单生成测试**：
   - 同步一个接近当前价格的扩展点位
   - 观察是否自动生成订单
   - 检查点位是否被清空

3. **RSI条件测试**：
   - 测试RSI>=75时是否生成空单
   - 测试RSI<=25时是否生成多单

