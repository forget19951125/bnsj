# 币安事件合约群控交易系统 - 产品文档

## 1. 项目概述

币安事件合约群控交易系统是一个分布式交易管理系统，分为后台管理系统和客户端程序两部分。系统允许管理员在后台配置交易订单，客户端自动拉取订单并执行交易。

## 2. 系统架构

### 2.1 系统组成

- **后台系统（Server）**：订单管理、用户管理、API服务
- **客户端系统（Client）**：自动登录、订单拉取、自动下单

### 2.2 技术栈

- **后端语言**：Python
- **数据库**：MySQL（存储订单、用户信息）
- **缓存**：Redis（订单去重、会话管理）

## 3. 后台系统功能

### 3.1 订单管理

#### 3.1.1 创建订单
管理员可以创建新的交易订单，订单包含以下字段：
- **timeIncrements**：时间增量（如 "TEN_MINUTE"）
- **symbolName**：交易对名称（如 "BTCUSDT"）
- **direction**：交易方向（"LONG" 或 "SHORT"）
- **有效时间**：订单有效期（单位：秒）

#### 3.1.2 订单去重机制
- 每个用户只能拉取同一个订单一次
- 使用 Redis 记录用户-订单的拉取关系
- 已拉取的订单不会再次分配给同一用户

#### 3.1.3 订单状态
- **待分配**：订单已创建，等待客户端拉取
- **已分配**：订单已被客户端拉取
- **已过期**：订单超过有效期，不再分配给客户端

### 3.2 用户管理

#### 3.2.1 用户注册
- 管理员可以在后台注册新用户账号
- 账号信息包括：用户名、密码等

#### 3.2.2 账号有效期管理
- 管理员可以为每个账号设置有效期（指定到期时间）
- 账号有效期到达后，账号自动过期
- 过期账号无法登录客户端
- 管理员可以重新设置有效期以恢复账号

#### 3.2.3 账号状态
- **正常**：账号在有效期内，可以正常使用
- **已过期**：账号已超过有效期，无法登录
- **已禁用**：管理员手动禁用的账号

## 4. 客户端系统功能

### 4.1 用户登录

#### 4.1.1 账号登录
- 客户端启动后首先显示登录界面
- 用户输入用户名和密码进行登录
- 登录成功后进入主界面

#### 4.1.2 登录有效期
- 每次登录有效期为 24 小时
- 超过 24 小时后，客户端自动退出到登录界面
- 需要重新登录才能继续使用

#### 4.1.3 账号过期检查
- 登录时检查账号是否过期
- 如果账号已过期，提示用户联系管理员

### 4.2 币安账号绑定

#### 4.2.1 扫码登录
- 登录成功后，需要先绑定币安账号
- 调用 `get_token()` 函数，显示二维码
- 用户使用币安 App 扫描二维码完成登录
- 获取并保存 token（csrftoken、p20t、expirationTimestamp）

#### 4.2.2 Token 管理
- Token 信息保存在本地
- Token 过期后需要重新扫码登录

### 4.3 交易设置

#### 4.3.1 下单金额设置
- 用户可以设置每次下单的金额（orderAmount）
- 金额范围：5 - 200 USDT
- 金额可以通过输入框调整
- 设置后立即生效

### 4.4 自动下单

#### 4.4.1 订单拉取
- 客户端每秒向服务器拉取一次订单
- 拉取接口返回可用的订单列表
- 系统自动过滤已拉取过的订单（去重）

#### 4.4.2 订单有效性检查
- 检查订单的创建时间和服务器当前时间的时间差
- 如果时间差超过订单的有效时间，跳过该订单
- 只处理在有效期内的订单

#### 4.4.3 自动下单执行
- 对于有效的订单，自动调用 `place_order_web()` 函数下单
- 下单参数：
  - orderAmount：用户设置的下单金额
  - timeIncrements：订单的时间增量
  - symbolName：订单的交易对
  - payoutRatio：固定为 "0.80"
  - direction：订单的交易方向

#### 4.4.4 下单结果处理
- 记录下单结果（成功/失败）
- 失败时记录错误信息
- 成功后将订单标记为已拉取（去重）

## 5. 数据流程

### 5.1 订单创建流程
```
管理员创建订单 → 保存到MySQL → 订单状态为"待分配"
```

### 5.2 订单拉取流程
```
客户端请求订单 → 服务器查询待分配订单 → 检查订单有效期 → 
检查用户是否已拉取（Redis去重） → 返回可用订单 → 
客户端接收订单 → 标记为已拉取（Redis）
```

### 5.3 下单流程
```
客户端获取订单 → 检查订单有效期 → 调用place_order_web() → 
返回下单结果 → 记录结果
```

## 6. 安全机制

### 6.1 账号安全
- 密码加密存储
- 登录 Token 有效期限制
- 账号有效期管理

### 6.2 订单安全
- 订单去重机制防止重复下单
- 订单有效期检查防止过期订单执行
- 下单金额限制（5-200 USDT）

### 6.3 币安 Token 安全
- Token 本地加密存储
- Token 过期自动重新登录

## 7. 性能要求

### 7.1 响应时间
- 订单拉取接口响应时间 < 500ms
- 下单接口响应时间 < 2s

### 7.2 并发支持
- 支持至少 100 个客户端同时在线
- 支持每秒至少 100 次订单拉取请求

## 8. 日志和监控

### 8.1 日志记录
- 订单创建、分配、执行日志
- 用户登录、登出日志
- 下单成功/失败日志
- 错误日志

### 8.2 监控指标
- 在线客户端数量
- 订单分配率
- 下单成功率
- 系统错误率

## 9. 部署要求

### 9.1 服务器要求
- Python 3.9+
- MySQL 5.7+
- Redis 6.0+

### 9.2 客户端要求
- Python 3.9+
- 支持图形界面（用于显示二维码）
- 网络连接稳定

## 10. 未来扩展

### 10.1 功能扩展
- 订单统计报表
- 用户交易历史查询
- 批量订单创建
- 订单模板管理

### 10.2 技术优化
- 订单推送机制（替代轮询）
- WebSocket 实时通信
- 分布式部署支持

