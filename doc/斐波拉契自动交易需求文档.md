# 斐波拉契扩展位自动交易系统需求文档

## 一、需求概述

集成`2.py`文件中的斐波拉契扩展位计算逻辑到服务器，实现基于斐波拉契扩展位和RSI指标的自动订单生成系统。

## 二、核心功能

### 2.1 斐波拉契扩展位计算与缓存

1. **触发条件**：参考`2.py`中的`send_instant_alert`函数
2. **计算内容**：30分钟时间窗口的双向斐波拉契1.618扩展位
   - 上升1.618点位（`fib_1618` from `up` direction）
   - 下降1.618点位（`fib_1618` from `down` direction）
3. **缓存机制**：
   - 当`send_instant_alert`触发时，将30分钟的双向点位同步到服务器
   - 使用Redis缓存，key格式：`fib:ethusdt:30min:up` 和 `fib:ethusdt:30min:down`
   - 缓存包含：点位价格、计算时间、A/B/C点信息

### 2.2 价格监控与订单生成

1. **监控频率**：服务器每秒获取一次ETHUSDT合约价格
2. **订单生成条件**：

   **空单生成条件**（上升扩展位）：
   - 合约价格 >= 上升1.618扩展点位
   - 当前分钟K的RSI >= 75
   - 生成订单：
     - 10分钟ETHUSDT空单（SHORT）
     - 30分钟ETHUSDT空单（SHORT）

   **多单生成条件**（下降扩展位）：
   - 合约价格 <= 下降1.618扩展点位
   - 当前分钟K的RSI <= 25
   - 生成订单：
     - 10分钟ETHUSDT多单（LONG）
     - 30分钟ETHUSDT多单（LONG）

3. **订单生成后处理**：
   - 清空缓存的扩展点位（删除Redis中的相关key）
   - 等待下一次`send_instant_alert`触发重新缓存

### 2.3 后台显示

1. **显示内容**：
   - 当前缓存的上升1.618点位
   - 当前缓存的下降1.618点位
   - 缓存时间
   - 当前ETHUSDT合约价格
   - 当前RSI值
   - 订单生成状态（是否已生成订单）

2. **显示位置**：后台管理界面的订单管理页面

### 2.4 交易币种限制

1. **前端**：移除BTCUSDT选项，只保留ETHUSDT
2. **后端**：订单创建API验证，只允许ETHUSDT
3. **数据库**：现有订单不受影响，新订单只允许ETHUSDT

## 三、技术实现

### 3.1 文件结构

```
bn_auto/server/
├── app/
│   ├── services/
│   │   ├── fib_service.py          # 斐波拉契计算服务（从2.py提取）
│   │   └── price_monitor.py        # 价格监控服务
│   ├── api/
│   │   ├── fib.py                  # 斐波拉契API（接收点位、查询点位）
│   │   └── order.py                # 订单API（修改：只允许ETHUSDT）
│   └── models/
│       └── fib_cache.py            # 斐波拉契缓存模型（可选）
```

### 3.2 核心服务

#### 3.2.1 FibService（斐波拉契服务）

**功能**：
- 从`2.py`提取斐波拉契计算逻辑
- 提供30分钟窗口的双向扩展位计算
- 缓存管理（Redis）

**主要方法**：
- `calculate_fib_1618_30min()`: 计算30分钟窗口的1.618扩展位
- `cache_fib_levels(up_level, down_level)`: 缓存扩展位
- `get_cached_fib_levels()`: 获取缓存的扩展位
- `clear_fib_cache()`: 清空缓存

#### 3.2.2 PriceMonitor（价格监控服务）

**功能**：
- 每秒获取ETHUSDT合约价格
- 计算当前分钟K的RSI
- 检查价格是否触及扩展位
- 触发订单生成

**主要方法**：
- `start_monitoring()`: 启动监控循环
- `get_ethusdt_price()`: 获取ETHUSDT合约价格
- `calculate_rsi()`: 计算RSI
- `check_and_create_orders()`: 检查条件并创建订单

### 3.3 API接口

#### 3.3.1 POST `/api/fib/sync-levels`

**功能**：同步斐波拉契扩展位到服务器

**请求体**：
```json
{
  "up_level": 3500.50,
  "down_level": 3200.30,
  "up_data": {
    "fib_1618": 3500.50,
    "a_price": 3000.00,
    "b_price": 3300.00,
    "c_price": 3250.00
  },
  "down_data": {
    "fib_1618": 3200.30,
    "a_price": 3400.00,
    "b_price": 3100.00,
    "c_price": 3150.00
  }
}
```

**响应**：
```json
{
  "code": 200,
  "message": "success"
}
```

#### 3.3.2 GET `/api/fib/current-levels`

**功能**：获取当前缓存的扩展位

**响应**：
```json
{
  "code": 200,
  "data": {
    "up_level": 3500.50,
    "down_level": 3200.30,
    "up_data": {...},
    "down_data": {...},
    "cached_at": "2024-01-01T12:00:00",
    "current_price": 3400.00,
    "current_rsi": 50.0
  }
}
```

### 3.4 订单生成逻辑

**订单参数**：
- `symbol_name`: "ETHUSDT"（固定）
- `time_increments`: "TEN_MINUTE" 或 "THIRTY_MINUTE"
- `direction`: "SHORT"（空单）或 "LONG"（多单）
- `valid_duration`: 
  - 10分钟订单：600秒
  - 30分钟订单：1800秒

**生成流程**：
1. 检查是否有缓存的扩展位
2. 获取当前ETHUSDT价格
3. 计算当前RSI
4. 判断是否满足条件
5. 如果满足，创建订单（10分钟+30分钟）
6. 清空缓存

## 四、数据流程

```
2.py (send_instant_alert触发)
    ↓
POST /api/fib/sync-levels (同步30分钟双向点位)
    ↓
Redis缓存 (fib:ethusdt:30min:up/down)
    ↓
PriceMonitor每秒检查
    ↓
获取ETHUSDT价格 + 计算RSI
    ↓
判断条件：
- 价格 >= 上升点位 && RSI >= 75 → 生成空单
- 价格 <= 下降点位 && RSI <= 25 → 生成多单
    ↓
创建订单（10分钟+30分钟）
    ↓
清空缓存
```

## 五、前端修改

### 5.1 订单创建表单

- 移除`symbol_name`选择框，固定为"ETHUSDT"
- 或隐藏该字段，默认值为"ETHUSDT"

### 5.2 后台显示

在订单管理页面添加"斐波拉契交易点位"区域：
- 显示当前缓存的上升/下降点位
- 显示当前价格和RSI
- 显示缓存时间
- 实时更新（每5秒刷新）

## 六、注意事项

1. **RSI计算**：需要确保RSI计算逻辑与`2.py`一致
2. **价格精度**：ETHUSDT价格比较需要考虑精度问题（建议使用0.01的容差）
3. **并发安全**：订单生成和缓存清空需要加锁，避免重复生成
4. **错误处理**：网络异常、API调用失败等需要妥善处理
5. **日志记录**：记录所有关键操作（点位缓存、订单生成等）

## 七、测试要点

1. 点位同步功能测试
2. 价格监控功能测试
3. RSI计算准确性测试
4. 订单生成条件判断测试
5. 缓存清空功能测试
6. 前后端币种限制测试



